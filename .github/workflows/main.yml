name: ðŸš€ Build Yemen Market

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Fix Gradle Configuration
      run: |
        # 0. Ø£Ù†Ø´Ø¦ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        mkdir -p gradle/wrapper
        mkdir -p app/src/main/java/com/yemenmarket
        mkdir -p app/src/main/res/layout
        
        # 1. Ø§Ø³ØªØ®Ø¯Ù… Gradle 8.4
        echo "distributionBase=GRADLE_USER_HOME" > gradle/wrapper/gradle-wrapper.properties
        echo "distributionPath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
        echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.4-bin.zip" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStoreBase=GRADLE_USER_HOME" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStorePath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
        
        # 2. Ø£Ù†Ø´Ø¦ settings.gradle.kts Ø§Ù„ØµØ­ÙŠØ­
        cat > settings.gradle.kts << 'EOF'
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        
        rootProject.name = "YemenMarket"
        include(":app")
        EOF
        
        # 3. Ø£Ù†Ø´Ø¦ build.gradle.kts Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        cat > app/build.gradle.kts << 'EOF'
        plugins {
            id("com.android.application")
            id("org.jetbrains.kotlin.android")
        }
        
        android {
            namespace = "com.yemenmarket"
            compileSdk = 34
            
            defaultConfig {
                applicationId = "com.yemenmarket"
                minSdk = 21
                targetSdk = 34
                versionCode = 1
                versionName = "1.0"
            }
            
            buildTypes {
                getByName("debug") {
                    isMinifyEnabled = false
                }
            }
        }
        
        dependencies {
            implementation("androidx.core:core-ktx:1.12.0")
            implementation("androidx.appcompat:appcompat:1.6.1")
        }
        EOF
        
        # 4. Ø¥ØµÙ„Ø§Ø­ gradlew
        if [ -f "gradlew" ]; then
          chmod +x gradlew
        else
          echo '#!/bin/sh' > gradlew
          echo 'gradle "$@"' >> gradlew
          chmod +x gradlew
        fi
        
    - name: Build APK
      run: |
        ./gradlew :app:assembleDebug --no-daemon --stacktrace
          
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: yemen-market-apk
        path: app/build/outputs/apk/debug/*.apk
